document.addEventListener('DOMContentLoaded', () => {
    const messageTextContentElement = document.getElementById('message-text-content');
    const choicesAreaElement = document.getElementById('choices-area');
    const feedbackTextElement = document.getElementById('feedback-text');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const quizAreaElement = document.getElementById('quiz-area');
    const resultAreaElement = document.getElementById('result-display-area');
    const restartBtn = document.getElementById('restart-btn');
    const progressBarElement = document.getElementById('progress-bar');
    const progressTextElement = document.getElementById('progress-text');
    const currentScoreValueElement = document.getElementById('current-score-value');
    const currentScoreDisplayElement = document.querySelector('.current-score-display');
    
    const attributedSpeakerNameElement = document.getElementById('attributed-speaker-name');
    const attributionQuestionArea = document.getElementById('attribution-question');

    const prevMessageContainer = document.getElementById('prev-message-container');
    const prevSpeakerNameElement = document.getElementById('prev-speaker-name');
    const prevMessageTextElement = document.getElementById('prev-message-text');
    const nextMessageContainer = document.getElementById('next-message-container');
    const nextSpeakerNameElement = document.getElementById('next-speaker-name');
    const nextMessageTextElement = document.getElementById('next-message-text');

    const resultIconContainer = document.getElementById('result-icon-container');
    const resultRankTitleElement = document.getElementById('result-rank-title');
    const finalScoreValueElement = document.getElementById('final-score-value');
    const totalQuestionsOnResultElement = document.getElementById('total-questions-on-result');
    const resultMessageElement = document.getElementById('result-message');
    
    const appContainer = document.querySelector('.app-container');

    let allQuizData = []; 
    let currentQuizSet = []; 
    let currentQuestionIndex = 0;
    let score = 0;
    const TARGET_NUM_QUESTIONS = 10;
    const QUIZ_DATA_FILE = "misattributed_context_quiz_data.json"; 

    async function initializeQuiz() {
        if(appContainer) {
             setTimeout(() => appContainer.classList.add('loaded'), 50);
        }
        try {
            const response = await fetch(QUIZ_DATA_FILE);
            if (!response.ok) throw new Error(`HTTP error! Quiz data not found (${QUIZ_DATA_FILE}). Status: ${response.status}`);
            allQuizData = await response.json(); 
            if (!Array.isArray(allQuizData) || allQuizData.length === 0) {
                displayError("„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åã„ÄÅÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            prepareNewQuizSet(); 
            startGame();
        } catch (error) {
            console.error("„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Åæ„Åü„ÅØÂàùÊúüÂåñ„Å´Â§±Êïó:", error);
            displayError(`„ÇØ„Ç§„Ç∫„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}. JSON„Éï„Ç°„Ç§„É´(${QUIZ_DATA_FILE})„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        }
    }

    function prepareNewQuizSet() {
        let shuffledData = shuffleArray([...allQuizData]); 
        currentQuizSet = shuffledData.slice(0, TARGET_NUM_QUESTIONS); 
        if (currentQuizSet.length === 0 && allQuizData.length > 0) {
             currentQuizSet = shuffledData.slice(0, allQuizData.length); 
        }
    }
    
    function displayError(message) { 
        quizAreaElement.innerHTML = `<p class="error-message">${message}</p>`;
        quizAreaElement.style.display = 'block';
        resultAreaElement.style.display = 'none';
        const header = document.querySelector('.quiz-header');
        if(header) header.style.display = 'none';
    }

    function startGame() {
        currentQuestionIndex = 0;
        score = 0;
        if(currentScoreValueElement) currentScoreValueElement.textContent = '0';
        if(currentScoreDisplayElement) currentScoreDisplayElement.classList.remove('score-updated');
        
        resultAreaElement.style.display = 'none';
        const resultCard = document.querySelector('.result-card');
        if(resultCard) { 
            resultCard.style.opacity = '0';
            resultCard.style.transform = 'translateY(30px) scale(0.95)';
            resultCard.style.animation = 'none'; 
            resultCard.offsetHeight; 
            resultCard.style.animation = ''; 
        }
        
        quizAreaElement.style.display = 'block';
        if(attributionQuestionArea) attributionQuestionArea.style.display = 'block'; 
        choicesAreaElement.className = 'choices-container binary-choices'; 

        nextQuestionBtn.style.display = 'none';
        feedbackTextElement.textContent = '';
        feedbackTextElement.className = 'feedback-text'; 
        
        if (currentQuizSet.length === 0) {
            displayError("Âá∫È°å„Åß„Åç„Çã„ÇØ„Ç§„Ç∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
            return;
        }
        updateProgress();
        displayQuestion();
    }

    function displayQuestion() {
        feedbackTextElement.className = 'feedback-text';
        if (currentQuestionIndex < currentQuizSet.length) {
            const q = currentQuizSet[currentQuestionIndex];
            
            if (q.prev_message_text && prevMessageContainer) {
                prevSpeakerNameElement.textContent = q.prev_speaker_display || "";
                prevMessageTextElement.innerHTML = q.prev_message_text.replace(/\n/g, '<br>');
                prevMessageContainer.style.display = 'block';
            } else if (prevMessageContainer) {
                prevMessageContainer.style.display = 'none';
                prevSpeakerNameElement.textContent = "";
                prevMessageTextElement.innerHTML = "";
            }

            messageTextContentElement.innerHTML = q.main_quote_text.replace(/\n/g, '<br>');
            
            if (q.next_message_text && nextMessageContainer) {
                nextSpeakerNameElement.textContent = q.next_speaker_display || "";
                nextMessageTextElement.innerHTML = q.next_message_text.replace(/\n/g, '<br>');
                nextMessageContainer.style.display = 'block';
            } else if (nextMessageContainer) {
                nextMessageContainer.style.display = 'none';
                nextSpeakerNameElement.textContent = "";
                nextMessageTextElement.innerHTML = "";
            }
            
            if(attributedSpeakerNameElement) attributedSpeakerNameElement.textContent = q.attributed_speaker_display;
            if(attributionQuestionArea) attributionQuestionArea.style.display = 'block';

            choicesAreaElement.innerHTML = ''; 
            const yesButton = document.createElement('button');
            yesButton.innerHTML = `<span>„ÅØ„ÅÑ„ÄÅ„Åì„ÅÆ‰∫∫„ÅÆÁô∫Ë®ÄÔºÅ</span>`;
            yesButton.dataset.answer = "yes";
            yesButton.addEventListener('click', () => handleAnswer("yes"));
            choicesAreaElement.appendChild(yesButton);

            const noButton = document.createElement('button');
            noButton.innerHTML = `<span>„ÅÑ„ÅÑ„Åà„ÄÅÈÅï„ÅÜ‰∫∫„ÅÆÁô∫Ë®ÄÔºÅ</span>`;
            noButton.dataset.answer = "no";
            noButton.addEventListener('click', () => handleAnswer("no"));
            choicesAreaElement.appendChild(noButton);
            
            nextQuestionBtn.style.display = 'none';
        } else {
            showResults();
        }
    }

    function handleAnswer(userChoice) {
        const currentQuestion = currentQuizSet[currentQuestionIndex];
        const isCorrectAttribution = currentQuestion.is_attribution_correct;
        const attributedSpeaker = currentQuestion.attributed_speaker_display;
        const actualSpeaker = currentQuestion.main_quote_actual_speaker_display;

        const buttons = choicesAreaElement.getElementsByTagName('button');
        for (let btn of buttons) {
            btn.disabled = true;
        }
        
        let answeredCorrectly = false;

        if (userChoice === "yes") {
            if (isCorrectAttribution) {
                answeredCorrectly = true;
                feedbackTextElement.textContent = `Ê≠£Ëß£ÔºÅ„Åì„Çå„ÅØÊú¨ÂΩì„Å´ ${attributedSpeaker} „Åï„Çì„ÅÆÁô∫Ë®Ä„Åß„Åó„ÅüÔºÅüéâ`;
            } else {
                feedbackTextElement.textContent = `ÊÆãÂøµ‚Ä¶ÔºÅ„Åì„Çå„ÅØ ${attributedSpeaker} „Åï„Çì„ÅÆÁô∫Ë®Ä„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÊú¨ÂΩì„ÅØ ${actualSpeaker} „Åï„Çì„ÅÆ„Çª„É™„Éï„Åß„Åô„ÄÇ`;
            }
        } else if (userChoice === "no") {
            if (!isCorrectAttribution) {
                answeredCorrectly = true;
                feedbackTextElement.textContent = `„ÅäË¶ã‰∫ãÔºÅ„Åù„ÅÆÈÄö„Çä„ÄÅ ${attributedSpeaker} „Åï„Çì„ÅÆÁô∫Ë®Ä„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºÅÔºàÊú¨ÂΩì„ÅØ ${actualSpeaker} „Åï„Çì„Åß„ÅôÔºâüëç`;
            } else {
                feedbackTextElement.textContent = `„ÅÇ„Çä„ÇÉ„ÄÅ„Åì„Çå„ÅØÊú¨ÂΩì„Å´ ${attributedSpeaker} „Åï„Çì„ÅÆÁô∫Ë®Ä„Å†„Å£„Åü„Çì„Åß„Åô„Çà„ÄÇ`;
            }
        }
        
        feedbackTextElement.className = 'feedback-text visible'; 
        if (answeredCorrectly) {
            score++;
            if(currentScoreValueElement) currentScoreValueElement.textContent = score;
            if(currentScoreDisplayElement) {
                currentScoreDisplayElement.classList.add('score-updated');
                setTimeout(() => currentScoreDisplayElement.classList.remove('score-updated'), 300);
            }
            feedbackTextElement.classList.add('correct');
            Array.from(buttons).find(btn => btn.dataset.answer === userChoice)?.classList.add('correct');
            if (typeof confetti === 'function' && score < TARGET_NUM_QUESTIONS) { // ÈÄöÂ∏∏„ÅÆÊ≠£Ëß£ÊôÇ
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, zIndex: 10000, scalar: 1.1, angle: randomRange(80,100) });
            }
        } else {
            feedbackTextElement.classList.add('wrong');
            Array.from(buttons).find(btn => btn.dataset.answer === userChoice)?.classList.add('wrong');
            feedbackTextElement.classList.add('feedback-text-shake');
            setTimeout(() => {
                feedbackTextElement.classList.remove('feedback-text-shake');
            }, 400); 
        }
        nextQuestionBtn.style.display = 'inline-flex';
    }

    function updateProgress() {
        const totalQuestionsInSet = currentQuizSet.length;
        if (totalQuestionsInSet > 0) {
            const progressPercentage = ((currentQuestionIndex) / totalQuestionsInSet) * 100;
            progressBarElement.style.width = `${progressPercentage}%`;
            progressTextElement.textContent = `ÂïèÈ°å ${currentQuestionIndex + 1} / ${totalQuestionsInSet}`;
        } else {
            progressBarElement.style.width = `0%`;
            progressTextElement.textContent = `ÂïèÈ°å - / -`;
        }
    }

    function showResults() {
        quizAreaElement.style.display = 'none';
        if(attributionQuestionArea) attributionQuestionArea.style.display = 'none';
        resultAreaElement.style.display = 'block'; 
        const resultCard = document.querySelector('.result-card');
        if(resultCard) { 
            resultCard.style.opacity = '0'; 
            resultCard.style.transform = 'translateY(30px) scale(0.95)';
            resultCard.style.animation = 'none'; 
            resultCard.offsetHeight; 
            resultCard.style.animation = ''; 
        }
        
        const totalAnswered = currentQuizSet.length;
        totalQuestionsOnResultElement.textContent = totalAnswered;
        let rank = '', rankTitle = '', message = '', iconClass = ''; 
        const correctAnswers = score;

        // ‚òÖÊñ∞„Åó„ÅÑ„É©„É≥„ÇØ„Å®„É°„ÉÉ„Çª„Éº„Ç∏ÂÆöÁæ©
        switch (correctAnswers) {
            case 10:
                rank = 'godlike'; rankTitle = "‰∏≠ÊØí„ÅäÁñ≤„ÇåÊßò„Åß„Åôü§°";
                message = "ÂÖ®Âïè„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ‚Ä¶„ÅÇ„Å™„Åü„ÄÅ„Åì„ÅÆ„Éà„Éº„ÇØÂ±•Ê≠¥„Åå„Å™„ÅÑ„Å®Áîü„Åç„Å¶„ÅÑ„Åë„Å™„ÅÑ‰Ωì„Å´„Å™„Å£„Å¶„Åæ„Åõ„Çì„ÅãÔºüÊó•Â∏∏ÁîüÊ¥ª„ÄÅ„Å°„ÇÉ„Çì„Å®ÈÄÅ„Çå„Å¶„Åæ„ÅôÔºü„Éû„Ç∏„ÅßÂøÉÈÖç„Åß„ÅôÔºàÊ£íË™≠„ÅøÔºâ„ÄÇ";
                iconClass = 'fas fa-skull-crossbones';
                if (typeof confetti === 'function') {
                    const end = Date.now() + (3.5 * 1000); // 3.5ÁßíÈñìÁ∂ôÁ∂ö
                    const colors = ['#1f2937', '#5e5af9', '#f59e0b', '#ef4444', '#f3e5f5']; // „ÉÜ„Éº„Éû„Ç´„É©„Éº„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥

                    (function frame() {
                        confetti({
                            particleCount: 5, angle: 60, spread: 65, origin: { x: 0, y: 0.65 },
                            colors: colors, scalar: Math.random() * 0.6 + 0.8, drift: Math.random() * 0.6 - 0.3
                        });
                        confetti({
                            particleCount: 5, angle: 120, spread: 65, origin: { x: 1, y: 0.65 },
                            colors: colors, scalar: Math.random() * 0.6 + 0.8, drift: Math.random() * -0.6 + 0.3
                        });
                        if (Date.now() < end) { requestAnimationFrame(frame); }
                    }());
                    setTimeout(() => { // ‰∏≠Â§Æ„Åã„Çâ„ÅÆÂ§ß„Åç„Å™„Éê„Éº„Çπ„Éà
                        confetti({ particleCount: 180, spread: 120, origin: { y: 0.55 }, colors: colors, scalar: 1.3, zIndex: 10001, ticks: 300 });
                    }, 400);
                }
                break;
            case 9:
                rank = 'ss'; rankTitle = "„Åª„Åº‰∏≠ÊØíËÄÖ („ÅÇ„Å®‰∏ÄÊÅØ)";
                message = "„Åä„Åó„ÅÑÔºÅ„ÅÇ„Å®1Âïè„Åß„Éà„Éº„ÇØÂ±•Ê≠¥„Å®È≠Ç„ÅåËûçÂêà„Åô„Çã„Å®„Åì„Çç„Åß„Åó„Åü„Å≠„ÄÇ„Åù„ÅÆÈõÜ‰∏≠Âäõ„ÄÅ„ÇÇ„ÅÜÂ∞ë„Åó„Å†„ÅëÂÆüÁîüÊ¥ª„Å´„ÇÇ‚Ä¶Ôºü";
                iconClass = 'fas fa-brain';
                break;
            case 8:
                rank = 's'; rankTitle = "„Éà„Éº„ÇØÂ±•Ê≠¥„ÅÆ‰Ωè‰∫∫";
                message = "„Åã„Å™„ÇäÊ≠£Á¢∫„Åò„ÇÉ„Å™„ÅÑ„Åß„Åô„Åã„ÄÇ„ÇÇ„Åó„Åã„Åó„Å¶„ÄÅ„Åì„ÅÆ‰ºöË©±„ÄÅÊò®Êó•„ÇÇÂ§¢„ÅßË¶ã„Åæ„Åó„Åü‚Ä¶Ôºü„Éá„Ç∏„É£„É¥„É•„Å£„Å¶„ÇÑ„Å§„Åß„Åô„ÅãÔºü";
                iconClass = 'fas fa-door-open';
                break;
            case 7:
                rank = 'a_plus'; rankTitle = "„Å™„Åã„Å™„Åã„ÅÆË®òÊÜ∂ÂäõÔºàÊöá‰∫∫ÁñëÊÉëÔºâ";
                message = "7Ââ≤Ê≠£Ëß£„Å®„ÅØ„ÄÅ„Å™„Åã„Å™„Åã„ÇÑ„Çä„Åæ„Åô„Å≠„ÄÇ‚Ä¶„Å®„Åì„Çç„Åß„ÄÅÊúÄËøë‰Ωï„Åã‰ªñ„Å´Ê•Ω„Åó„ÅÑ„Åì„Å®„ÄÅË¶ã„Å§„Åë„Åæ„Åó„Åü‚Ä¶Ôºü";
                iconClass = 'fas fa-hourglass-half';
                break;
            case 6:
                rank = 'a'; rankTitle = "„Åù„Åì„Åù„ÅìÂΩì„Åü„ÇãÂãò";
                message = "ÂçäÂàÜ‰ª•‰∏ä„ÅØ„ÇØ„É™„Ç¢ÔºÅÁ¨¨ÂÖ≠ÊÑü„Åß„Åô„ÅãÔºü„Åù„Çå„Å®„ÇÇ‚Ä¶„Åì„ÅÆ„ÇØ„Ç§„Ç∫„ÄÅ‰ΩïÂë®ÁõÆ„Åß„Åô‚Ä¶Ôºü";
                iconClass = 'fas fa-wand-magic-sparkles';
                break;
            case 5:
                rank = 'b_plus'; rankTitle = "‰∫îÂàÜ‰∫îÂàÜ„ÅÆÂçöÂæí";
                message = "„Å°„Çá„ÅÜ„Å©ÂçäÂàÜÔºÅ„Ç≥„Ç§„É≥„Éà„Çπ„Åß„ÇÇÂêå„Åò„Åè„Çâ„ÅÑ„ÅÆÁ¢∫Áéá„ÅåÂá∫„Åù„ÅÜ„Åß„Åô„Å≠ÔºÅÊ¨°„ÅØ„Åù„ÅÆ„Ç≥„Ç§„É≥„ÄÅË™∞„Å´„ÇÇË¶ã„Åõ„Åö„Å´Êè°„Çä„Åó„ÇÅ„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü";
                iconClass = 'fas fa-coins';
                break;
            case 4:
                rank = 'b'; rankTitle = "„ÅÇ„ÇåÔºü„Å©„Åì„Åã„ÅßË¶ã„Åü„Çà„ÅÜ„Å™‚Ä¶";
                message = "„ÅÜ„Éº„Çì„ÄÅ„Éá„Ç∏„É£„É¥„É•„Åã„Å®ÊÄù„ÅÑ„Åç„ÇÑ„ÄÅ„Å†„ÅÑ„Åü„ÅÑÂ§ñ„Çå„Å¶„Åæ„Åô„Å≠„ÄÇÂ§¢„ÅÆÁ∂ö„Åç„Åß„ÇÇË¶ã„Å¶„Åæ„Åó„ÅüÔºü„Åù„Çå„Å®„ÇÇÁèæÂÆüÈÄÉÈÅøÔºü";
                iconClass = 'fas fa-cloud-moon'; // Â∞ë„ÅóÂπªÊÉ≥ÁöÑ„Å™ÊÑü„Åò„Å´
                break;
            case 3:
                rank = 'c_plus'; rankTitle = "„ÇÇ„Åó„Åã„Åó„Å¶Ôºö‰π±Ë¶ñ";
                message = "3Ââ≤„Åß„Åô„Åã‚Ä¶„ÄÇÂ§ß‰∏àÂ§´„ÄÅÁîªÈù¢„ÅÆ„Åõ„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÇàÔºü„Åù„Çå„Åã‚Ä¶ÂøÉ„ÅÆ„Éî„É≥„Éà„ÅåÂêà„Å£„Å¶„Å™„ÅÑ„Å®„ÅãÔºü„Éù„Ç®„É†Ôºü";
                iconClass = 'fas fa-glasses';
                break;
            case 2:
                rank = 'c'; rankTitle = "„Åª„ÅºÂÖ®Âïè‰∏çÊ≠£Ëß£„ÅÆÂå†";
                message = "„Åì„Åì„Åæ„ÅßÂ§ñ„Åõ„Çã„ÅÆ„ÅØ„ÄÅ„ÇÇ„ÅØ„ÇÑ‰∏ÄÁ®Æ„ÅÆÊâçËÉΩ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Å≠ÔºÅ‚Ä¶„Åù„ÅÆÊâçËÉΩ„ÄÅ‰ªñ„ÅßÊ¥ª„Åã„Åõ„ÇãÂ†¥ÊâÄ„ÇíÊé¢„Åó„Åæ„Åó„Çá„ÅÜÔºÅ„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å´ÔºÅ";
                iconClass = 'fas fa-paint-roller';
                break;
            case 1:
                rank = 'd_plus'; rankTitle = "Â•áË∑°„ÅÆÔºëÂïèÊ≠£Ëß£";
                message = "„Åô„Åî„ÅÑÔºÅÔºëÂïè„Å†„ÅëÂΩì„Åü„Çä„Åæ„Åó„Åü„Å≠ÔºÅÂÆù„Åè„Åò„ÇÇË≤∑„Å£„Å¶„Åø„Å¶„ÅØÔºü‚Ä¶„ÅÑ„ÇÑ„ÄÅ„Åù„ÅÆÈÅã„ÅØ„Åì„Åì„Åß‰Ωø„ÅÑÊûú„Åü„Åó„ÅüÂèØËÉΩÊÄß„ÅåÊøÉÂéö„Åß„Åô„ÄÇ";
                iconClass = 'fas fa-dice-one';
                break;
            case 0:
            default:
                rank = 'd'; rankTitle = "‰ºùË™¨„ÅÆ„Éé„Éº„Éí„ÉÉ„Éà„Éé„Éº„É©„É≥";
                message = "ÂÖ®Âïè‰∏çÊ≠£Ëß£ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„ÅÇ„Å™„Åü„ÅØ„ÄéÁ©∫Ê∞ó„ÇíË™≠„Åæ„Å™„ÅÑ„Äè„ÅÆ„Åß„ÅØ„Å™„Åè„ÄéÁ©∫Ê∞ó„ÅåË™≠„ÇÅ„Å™„ÅÑ„Äè„Å®„ÅÑ„ÅÜÁ®ÄÊúâ„Å™ÊâçËÉΩ„ÅÆÊåÅ„Å°‰∏ª„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„ÇìÔºÅ„ÅÑ„ÇÑ„ÄÅÊú¨ÂΩì„Å´„Åô„Åî„ÅÑÔºàËâ≤„Çì„Å™ÊÑèÂë≥„ÅßÔºâ„ÄÇ";
                iconClass = 'fas fa-ghost';
                break;
        }
        
        resultIconContainer.className = `result-icon-container rank-${rank}`; 
        resultIconContainer.innerHTML = `<i class="${iconClass}"></i>`;
        resultRankTitleElement.textContent = rankTitle;
        resultRankTitleElement.className = `result-rank-title rank-${rank}`; 
        resultMessageElement.textContent = message;
        animateValue(finalScoreValueElement, 0, score, 700 + score * 60);
        progressBarElement.style.width = '100%';
        progressTextElement.textContent = `ÂÖ® ${totalAnswered} ÂïèÂÆå‰∫ÜÔºÅ`;
    }
    
    function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    function shuffleArray(array) { 
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    function randomRange(min, max) { return Math.random() * (max - min) + min; }
    
    document.getElementById('current-year').textContent = new Date().getFullYear();
    nextQuestionBtn.addEventListener('click', () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuizSet.length) {
            displayQuestion();
            updateProgress(); 
        } else {
            progressBarElement.style.width = '100%'; 
            progressTextElement.textContent = `ÁµêÊûú„ÇíË®àÁÆó‰∏≠...`; 
            showResults();
        }
    });
    restartBtn.addEventListener('click', () => {
        prepareNewQuizSet(); 
        startGame();
    });
    initializeQuiz();
});
